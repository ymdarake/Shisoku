# ゲーム仕様書

## ゲーム概要

**四則（Shisoku）** は、4つの数字と四則演算（+、-、×、÷）を使って目標の数字を作る数学パズルゲームです。

- **ジャンル**: 数学パズル
- **プレイ時間**: 約3-5分（10問）
- **対象**: 小学生から大人まで

## ゲームルール

### 基本ルール

1. **4つの数字を全て1回ずつ使う**
   - 提示された4つの数字（0-9）を全て使用する必要がある
   - 各数字は1回のみ使用可能

2. **四則演算を使用**
   - 使用可能な演算子: `+`、`-`、`*`、`/`
   - 括弧 `(` `)` も使用可能

3. **目標の数字を作る**
   - 計算結果が目標の数字（0-9）と一致すれば正解

### 重要な制約

| 制約 | 説明 | 例 |
|------|------|-----|
| **全数字使用必須** | 4つの数字を全て使う必要がある | ❌ `8 + 2` （4つ使っていない） |
| **数字の結合禁止** | 連続した数字入力で2桁以上の数を作ることは不可 | ❌ `1` と `2` で `12` を作る |
| **割り算は整数のみ** | 割り算の結果が整数でない場合は無効 | ✅ `8/2=4`<br>❌ `7/2=3.5` |
| **ゼロ除算禁止** | 0で割ることは不可 | ❌ `8/0` |

### 式の構築ルール

#### 有効な入力パターン

- **数字 → 演算子 → 数字**: `8 + 2`
- **数字 → 演算子 → 括弧開 → 数字**: `8 * (2 + 1)`
- **括弧開 → 数字**: `(8 + 2)`
- **数字 → 括弧閉**: `(8 + 2) * 5`
- **括弧閉 → 演算子**: `(8 + 2) / 5`

#### 無効な入力パターン

| パターン | 理由 | 例 |
|----------|------|-----|
| **数字 → 数字** | 数字の後に数字を置けない | ❌ `1 2` |
| **数字 → 括弧開** | 数字の後に開き括弧を置けない | ❌ `1 (` |
| **演算子 → 演算子** | 演算子の後に演算子を置けない | ❌ `+ *` |
| **括弧の不均衡** | 開き括弧と閉じ括弧の数が一致しない | ❌ `((8 + 2)` |

### 自動判定

以下の3条件が揃うと、自動的に答えが判定されます:

1. ✅ 4つの数字を全て使用
2. ✅ 最後のトークンが数字または閉じ括弧
3. ✅ 括弧が正しくバランスしている

## ゲームフロー

### 1. スタート画面（StartScreen）

- ゲームルールと例題を表示
- 言語切替（日本語/英語）
- 「スタート」ボタンでゲーム開始

### 2. カウントダウン画面（CountdownScreen）

- **3、2、1** のカウントダウン表示
- **バックグラウンド処理**: この間に全10問を事前生成
- **効果音**:
  - カウントダウン音（A4音、各1秒）
  - スタート音（C5→E5→C6の上昇和音）

### 3. ゲーム画面（GameScreen）

#### 表示要素

- **ヘッダー**: 問題番号（1/10形式）、タイマー、スコア
- **問題表示**: 4つの数字と目標の数字
- **入力エリア**: 構築中の式を表示
- **コントロール**: 数字ボタン、演算子ボタン、括弧ボタン、クリアボタン
- **メッセージエリア**: 正解/不正解のフィードバック

#### 操作フロー

1. **数字・演算子ボタンをクリック**して式を構築
2. **4つの数字を全て使用**すると自動判定
3. **正解**:
   - 緑色の「正解！」メッセージ表示
   - 正解音（3和音上昇）再生
   - 自動的に次の問題へ進む
4. **不正解**:
   - 赤色の「不正解」メッセージ表示
   - 不正解音（不協和音）再生
   - 式が自動的にクリアされ、再挑戦可能

#### スコアリング

- **正解時**: 残り時間に応じてポイント獲得
- **不正解時**: ペナルティなし（再挑戦可能）
- **最終スコア**: 10問の合計ポイント

### 4. 終了画面（EndScreen）

- **結果表示**:
  - 最終スコア
  - 正解数 / 10
  - 総プレイ時間
- **アクション**:
  - ランキングに名前を登録（任意）
  - 「ランキングを見る」ボタン
  - 「もう一度プレイ」ボタン

### 5. ランキング画面（RankingScreen）

- **表示内容**:
  - 順位（1-10位）
  - プレイヤー名
  - スコア
  - プレイ時間
- **ソート順**: スコア降順 → 時間昇順
- **保存**: localStorage に永続化（最大10件）

## 問題生成ロジック

### アルゴリズム

1. **4つのランダムな数字を生成**（0-9）
2. **全ての組み合わせを探索**:
   - 順列組み合わせ: 4! = 24通り
   - 演算子組み合わせ: 4³ = 64通り
   - 括弧パターン: 5種類
3. **有効な解答を探す**:
   - 結果が0-9の整数になる組み合わせ
   - 最大5000回試行
4. **失敗時のフォールバック**:
   - 事前定義された解答可能な問題を使用

### 解答可能性の保証

- **必ず解答可能な問題のみ生成**
- 生成失敗時はフォールバック問題を返す
- ユーザーが解けない問題は提示しない

## 音楽・効果音仕様

### BGM

**4トラック構成** (Tone.js FM合成):

| トラック | 音色 | 役割 |
|----------|------|------|
| メロディ | FMシンセ | 主旋律 |
| ベース | FMシンセ（低音） | リズム基盤 |
| キック | 低周波 | ビート |
| ハイハット | ノイズ | リズム装飾 |

### SFX（効果音）

| 効果音 | タイミング | 音色 |
|--------|-----------|------|
| **クリック音** | ボタンクリック時 | 短い高音 |
| **正解音** | 正解時 | C5→E5→G5の上昇3和音 |
| **不正解音** | 不正解時 | B4→C5の不協和音 |
| **無効操作音** | 無効な入力時 | 低い警告音 |
| **カウントダウン音** | カウントダウン時 | A4音（各1秒） |
| **スタート音** | ゲーム開始時 | C5→E5→C6の上昇和音 |

### ボリューム管理

- **BGM ON/OFF**: 独立して制御可能
- **SFX ON/OFF**: 独立して制御可能
- **初期化**: ユーザーインタラクション後に `Tone.start()`

## 多言語対応

### サポート言語

- 🇯🇵 **日本語** (デフォルト)
- 🇬🇧 **英語**

### 翻訳対象

- UIテキスト（ボタン、ラベル）
- ゲームルール
- メッセージ（正解/不正解）
- 例題の説明

## 技術的制約

| 項目 | 制約 | 理由 |
|------|------|------|
| **式評価** | `new Function()` 使用 | サーバーサイドレンダリング不可 |
| **音声ライブラリ** | Tone.js CDN依存 | インターネット接続必須 |
| **ストレージ** | localStorage 依存 | ブラウザのプライベートモードで制限あり |
| **ブラウザAPI** | Web Audio API 必須 | 古いブラウザでは動作しない可能性 |

## パフォーマンス最適化

- **問題の事前生成**: カウントダウン中に全10問を一括生成
- **音声の遅延読み込み**: ユーザーインタラクション後に初期化
- **状態管理の集中化**: App.tsx で一元管理し、不要な再レンダリングを防止
